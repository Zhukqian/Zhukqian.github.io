---
layout:     post
title:      线程池遇到的问题总结
subtitle:   JAVA
date:       2019-01-31
author:     朱坤乾
header-img: ""
catalog: true
tags:
    - JAVA
---
##  简单线程池原理
![]("https://img-blog.csdn.net/20170618213838961?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMTI0MDg3Nw==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast")
1 首先线程池判断基本线程池是否已满？没满，创建一个工作线程来执行任务。满了，则进入下个流程。  
2 其次线程池判断工作队列是否已满？没满，则将新提交的任务存储在工作队列里。满了，则进入下个流程。
3 最后线程池判断整个线程池是否已满？没满，则创建一个新的工作线程来执行任务，满了，则交给饱和策略来处理这个任务

本人简单理解:
第一次，先判断当前的核心线程数，
如果小于初始化的值，马上创建；然后第二个if,将这个任务插入到工作线程，双重判断任务，假定如果前面不能直接加入到线程池Worker集合里，则加入到workQueue队列等待执行。
里面的if else判断语句则是检查当前线程池的状态。如果线程池本身的状态是要关闭并清理了，
我们则不能提交线程进去了。这里我们就要reject他们。

##  Executors创建的四种线程池
    newFixedThreadPool(int Threads):创建固定数目的线程池。
    newSingleThreadPoolExecutor():创建一个单线程化的Executor
    newCacheThreadPool():创建一个可缓存的线程池，调用execute将重用以前构成的线程（如果线程可用）。
    如果没有可用的线程，则创建一个新线程并添加到池中。终止并从缓存中移出那些已有60秒钟未被使用的线程。
    newScheduledThreadPool(int corePoolSize)创建一个支持定时及周期性的任务执行的线程池，
    多数情况下可用来替代Time类。
	
>但是在阿里巴巴java开发手册中明确指出，不允许使用Executors创建线程池。

##  创建线程池的正确方法：
其实当了解线程池原理后,我们可以自己直接调用ThreadPoolExecutor的构造函数自己创建线程池。
在创建的同时，给BlockQueue指定容量大的容量就可以了。可以保证所有线程正常进行,不采用拒绝策略
```
ThreadPoolExecutor
(int corePoolSize, 
int maximumPoolSize, 
long keepAliveTime, 
TimeUnit unit, 
BlockingQueue<Runnable> workQueue, 
ThreadFactory threadFactory, 
RejectedExecutionHandler handler)
```
>构造方法参数说明
1:corePoolSize
核心线程数，默认情况下核心线程会一直存活，即使处于闲置状态也不会受存keepAliveTime限制。
除非将allowCoreThreadTimeOut设置为true。
2:maximumPoolSize
线程池所能容纳的最大线程数。超过这个数的线程将被阻塞。当任务队列为没有设置大小的LinkedBlockingDeque时，这个值无效。
3:keepAliveTime
非核心线程的闲置超时时间，超过这个时间就会被回收。
4:unit
指定keepAliveTime的单位，如TimeUnit.SECONDS。当将allowCoreThreadTimeOut设置为true时对corePoolSize生效。
5:workQueue
线程池中的任务队列.
常用的有三种队列，SynchronousQueue,LinkedBlockingDeque,ArrayBlockingQueue。
6:threadFactory
线程工厂，提供创建新线程的功能。ThreadFactory是一个接口，只有一个方法
```
public interface ThreadFactory {
  Thread newThread(Runnable r);
}
```

7RejectedExecutionHandler
通过线程工厂可以对线程的一些属性进行定制。
RejectedExecutionHandler也是一个接口，只有一个方法
当线程池中的资源已经全部使用，添加新线程被拒绝时，会调用RejectedExecutionHandler的rejectedExecution方法。

